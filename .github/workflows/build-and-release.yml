name: Bygging og publisering av release og snapshot

on:
  push:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
        releasing: ${{ steps.check-release.outputs.releasing }}
    steps:
      - name: Determine if releasing
        id: check-release
        run: |
          if [[ '${{ github.ref_name }}' != 'main' ]]; then
            echo "Not on main branch, skipping release"
            echo "releasing=false">> $GITHUB_OUTPUT
          
          elif [[ "${{ github.event.head_commit.message }}" == *"[release]"* ]]; then
            echo "Release commit detected"
            echo "releasing=true" >> $GITHUB_OUTPUT
          
          else
            echo "releasing=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Bygg, test og publiser snapshot
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Java
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: '21'
          distribution: temurin
          cache: maven

      - name: Check version from pom.xml
        run: |
          RAW_VER=$(./mvnw -q -N help:evaluate -Dexpression=project.version -DforceStdout)
          echo "Raw version: $RAW_VER"
          if [[ "$RAW_VER" != *"-SNAPSHOT" ]]; then
            echo "::error::Pom-versjonen må være X.Y.Z-SNAPSHOT (fant: $RAW_VER)"; exit 1
          fi

      - name: Bygg og test prosjektet
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: ./mvnw -B verify

      - name: Publiser Snapshot til GitHub Packages
        if: ${{ needs.prepare.outputs.releasing  == 'false' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: ./mvnw -B deploy -DskipTests

  release:
    needs: [prepare, build]
    if: ${{ needs.prepare.outputs.releasing  == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: '21'
          distribution: temurin
          cache: maven

      - name: Install GH CLI
        uses: dev-hanz-ops/install-gh-cli-action@af38ce09b1ec248aeb08eea2b16bbecea9e059f8 # v0.2.1
        with:
          gh-cli-version: 2.82.1 # renovate: github-releases=cli/cli

      - name: Opprett GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Calculate new tag for versioning
        id: calculate-version
        uses: paulhatch/semantic-version@a8f8f59fd7f0625188492e945240f12d7ad2dca3 #v5.4.0
        with:
          tag_prefix: ""
          search_commit_body: false
          version_format: '${major}.${minor}.${patch}'
          major_pattern: '/(\!: |BREAKING CHANGE)/'
          minor_pattern: '/^(feat|feature)/'

      - name: Set Maven release version (X.Y.Z)
        run: |
          ./mvnw -B versions:set -DnewVersion=${{ steps.calculate-version.outputs.version }} -DgenerateBackupPoms=false
          git ls-files --others --exclude-standard --cached -- '*.xml' | grep 'pom.xml$' | grep -v '/target/' | xargs git add

      - name: Commit og Push med signatur
        uses: dsanders11/github-app-commit-action@43de6da2f4d927e997c0784c7a0b61bd19ad6aac #v1.5.0
        with:
          message: "chore(release): Release av versjon ${{ steps.calculate-version.outputs.version }} [skip actions]"
          token: ${{ steps.app-token.outputs.token }}
          fail-on-no-changes: false

      - name: Publish with Maven
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: ./mvnw -B deploy -DskipTests

      - name: Set start tag for generating notes
        id: set-start-tag
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -x
          if [[ -z "${{ inputs.notes-start-tag }}" ]]; then
            set +e # Fail silently if no releases are found
            LATEST_TAG_OR_ERROR=$(gh api repos/${{github.repository}}/releases/latest --jq .tag_name 2>/dev/null)
            LATEST_TAG=$(if [[ $? = 0 ]]; then echo "$LATEST_TAG_OR_ERROR"; else echo "none"; fi)
            echo "notes-start-tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          else
            echo "notes-start-tag=$inputs.notes-start-tag" >> $GITHUB_OUTPUT
          fi

      - name: Create Github Release ${{ inputs.tag }} with generated notes
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          if [[ "${{ steps.set-start-tag.outputs.notes-start-tag }}" == "none" ]]; then
            gh release create ${{ inputs.tag }} --generate-notes
          else
            gh release create ${{ inputs.tag }} --generate-notes --notes-start-tag ${{ steps.set-start-tag.outputs.notes-start-tag }}
          fi

      - name: Determine next snapshot version
        id: bump-semver
        uses: actions-ecosystem/action-bump-semver@34e334551143a5301f38c830e44a22273c6ff5c5 #v1.0.0
        with:
          current_version: ${{ steps.calculate-version.outputs.version }}
          level: patch

      - name: Update pom to snapshot version
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          ./mvnw -B versions:set -DnewVersion="${{ steps.bump-semver.outputs.new_version }}-SNAPSHOT" -DprocessAllModules=true -DgenerateBackupPoms=false
          git ls-files --others --exclude-standard --cached -- '*.xml' | grep 'pom.xml$' | grep -v '/target/' | xargs git add

      - name: Commit and push snapshot version
        uses: dsanders11/github-app-commit-action@43de6da2f4d927e997c0784c7a0b61bd19ad6aac #v1.5.0
        with:
          message: "chore(snapshot): Bump snapshot-versjon til ${{ steps.bump-semver.outputs.new_version }}-SNAPSHOT"
          token: ${{ steps.app-token.outputs.token }}
